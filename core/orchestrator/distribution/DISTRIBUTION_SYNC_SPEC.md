# Distribution & Sync Specification

Purpose: Define how canonical orchestration assets from AGENT-33 are distributed to downstream repositories and kept in sync.

Related docs:
- `core/orchestrator/RELEASE_CADENCE.md` (release cadence and versioning)
- `core/orchestrator/CONTINUOUS_IMPROVEMENT.md` (improvement intake process)
- `core/orchestrator/config-gen/GENERATOR_SPEC.md` (config generation)

---

## Sync Architecture

### Core Principles

| Principle | Description |
|-----------|-------------|
| **Canonical Source** | AGENT-33 is the single upstream source of truth for all orchestration specs |
| **One-Way Flow** | Sync direction is always AGENT-33 to downstream, never reverse |
| **Selective Sync** | Downstream repos declare which subsets of `core/` they consume |
| **Immutable Releases** | Synced content is tied to tagged releases, not arbitrary commits |

### Flow Diagram

```
AGENT-33 (canonical)
  core/
    orchestrator/
    arch/
    prompts/
    agents/
        |
        v
  [Sync Engine]
    - Reads sync rules per downstream repo
    - Applies transforms (path rewrite, link strip)
    - Validates output
    - Opens PR in downstream repo
        |
        +---> Downstream Repo A (receives orchestrator/ + arch/)
        +---> Downstream Repo B (receives prompts/ only)
        +---> Downstream Repo C (receives full core/ mirror)
```

### Boundaries

- Downstream repos never push changes back to AGENT-33 `core/`.
- Local customizations in downstream repos are isolated in `.agent33-overrides/`.
- Sync only operates on tagged releases or explicit manual triggers.

---

## Sync Rules Schema

Each downstream repo defines its sync configuration in a `sync-rules.yaml` file stored in `core/orchestrator/distribution/rules/`.

```yaml
sync_rule:
  id: string                          # Unique rule identifier (e.g., "sync-repo-a-specs")
  source: "core/**/*.md"              # Glob pattern for upstream files
  target_repo: string                 # Downstream repository name (org/repo)
  target_path: string                 # Destination path in downstream repo
  strategy: copy | template | reference
  frequency: on_release | on_change | manual
  filters:
    include: [glob patterns]          # Files to include from source
    exclude: [glob patterns]          # Files to exclude from source
  transforms:
    - strip_internal_links: true      # Remove links to internal-only docs
    - rewrite_paths:
        from: "core/"
        to: "docs/agent33/"
  validation:
    checksum: true                    # Verify file integrity post-sync
    schema_check: true                # Validate JSON/YAML schemas still pass
```

### Strategy Definitions

| Strategy | Behavior |
|----------|----------|
| **copy** | Direct file copy with optional transforms applied |
| **template** | Process files through template engine, injecting downstream-specific variables |
| **reference** | Place a stub file linking back to AGENT-33 canonical source (no content copy) |

### Frequency Definitions

| Frequency | Trigger |
|-----------|---------|
| **on_release** | Runs automatically when a new AGENT-33 release is tagged |
| **on_change** | Runs when matched source files change on the main branch |
| **manual** | Runs only when explicitly triggered by an operator |

### Example Rule

```yaml
sync_rule:
  id: "sync-webapp-orchestrator"
  source: "core/orchestrator/**/*.md"
  target_repo: "org/webapp"
  target_path: "docs/agent33/orchestrator/"
  strategy: copy
  frequency: on_release
  filters:
    include:
      - "core/orchestrator/*.md"
      - "core/orchestrator/handoff/*.md"
    exclude:
      - "core/orchestrator/distribution/**"
  transforms:
    - strip_internal_links: true
    - rewrite_paths:
        from: "core/"
        to: "docs/agent33/"
  validation:
    checksum: true
    schema_check: true
```

---

## PR Template for Sync

When the sync engine pushes updates downstream, it opens a PR using this template.

### Title Format

```
sync(agent33): Update {spec-name} from v{version}
```

### Body Template

```markdown
## Sync Update from AGENT-33

**Source release:** v{version}
**Sync rule:** {rule-id}
**Files changed:** {count}

### Changelog Excerpt

{changelog-excerpt-for-synced-files}

### Diff Summary

- Added: {added-count} files
- Modified: {modified-count} files
- Removed: {removed-count} files

### Validation Results

| Check | Status |
|-------|--------|
| Checksum verification | {pass/fail} |
| Link integrity | {pass/fail} |
| Schema compatibility | {pass/fail} |
| Secret scan | {pass/fail} |
| Version tag match | {pass/fail} |

---
*This PR was auto-generated by the AGENT-33 sync engine.*
```

### PR Metadata

| Field | Value |
|-------|-------|
| **Labels** | `agent33-sync`, `auto-generated` |
| **Reviewers** | Auto-assigned based on `CODEOWNERS` file path matches in downstream repo |
| **Branch name** | `agent33-sync/v{version}/{rule-id}` |
| **Auto-merge** | Enabled only if all validation checks pass and repo policy allows |

---

## Sync Validation Checks

Every sync operation runs these checks before the downstream PR is opened.

| # | Check | Description | Failure Action |
|---|-------|-------------|----------------|
| 1 | **File checksum verification** | SHA-256 of each synced file matches the source after transforms | Block PR, log mismatch |
| 2 | **Link integrity** | No broken cross-references after path rewrites and link stripping | Block PR, list broken links |
| 3 | **Schema compatibility** | JSON and YAML schemas embedded in specs still validate | Block PR, report schema errors |
| 4 | **Secret scan** | No internal-only content, credentials, or private paths in output | Block PR, flag violations |
| 5 | **Version tag present** | Synced files contain the correct version tag in frontmatter or header | Warn, allow PR with note |

### Validation Output

```yaml
sync_validation:
  rule_id: "sync-webapp-orchestrator"
  run_at: "2026-01-30T12:00:00Z"
  source_version: "v2.4.0"
  checks:
    - name: checksum
      status: pass
      details: "12/12 files match"
    - name: link_integrity
      status: pass
      details: "0 broken links"
    - name: schema_check
      status: pass
      details: "3 schemas validated"
    - name: secret_scan
      status: pass
      details: "0 violations"
    - name: version_tag
      status: pass
      details: "v2.4.0 present in all files"
  overall: pass
```

---

## Conflict Resolution

### Override Mechanism

Downstream repos may customize synced content by placing override files in `.agent33-overrides/`. These overrides are preserved across syncs.

```
downstream-repo/
  docs/agent33/
    orchestrator/
      RELEASE_CADENCE.md        # Synced from AGENT-33
      TRACE_SCHEMA.md           # Synced from AGENT-33
  .agent33-overrides/
    orchestrator/
      RELEASE_CADENCE.md        # Local customizations (merged on sync)
```

### Three-Way Merge

When a sync encounters files that have downstream overrides:

1. **Base:** Previous sync snapshot (stored in `.agent33-sync-state/`)
2. **Ours:** Downstream override in `.agent33-overrides/`
3. **Theirs:** New upstream canonical from AGENT-33

The merge follows standard three-way logic:
- Changes only in upstream: accept upstream.
- Changes only in downstream override: preserve override.
- Changes in both: flag as conflict for manual resolution.

### Manual Conflict Resolution

When conflicts cannot be auto-resolved:

1. Sync PR is opened with conflict markers in affected files.
2. PR description lists all conflicts with file paths and line ranges.
3. Designated reviewer resolves conflicts manually.
4. Resolution is logged in the downstream repo's `DECISIONS.md`:

```yaml
conflict_resolution:
  date: "2026-01-30"
  sync_version: "v2.4.0"
  file: "docs/agent33/orchestrator/RELEASE_CADENCE.md"
  decision: "Kept downstream override for release schedule section"
  resolved_by: "human-reviewer"
```

---

## Rollback Procedure

If a sync introduces issues in a downstream repo, follow this procedure.

### Steps

| Step | Action | Command / Detail |
|------|--------|-----------------|
| 1 | **Identify sync commit** | Find the merge commit from the `agent33-sync/*` branch |
| 2 | **Revert to previous sync point** | `git revert <sync-merge-commit>` |
| 3 | **Re-run validation checks** | Execute sync validation suite against the reverted state |
| 4 | **Document rollback** | Add entry to downstream `DECISIONS.md` |
| 5 | **Notify upstream** | Open issue in AGENT-33 describing the failure |

### Rollback Log Entry

```yaml
rollback:
  date: "2026-01-30"
  sync_version: "v2.4.0"
  reverted_commit: "abc1234"
  reason: "Schema validation failures in downstream CI"
  restored_to: "v2.3.1 sync state"
  follow_up_issue: "AGENT-33#456"
  logged_by: "operator"
```

---

## Monitoring & Alerts

### Sync Staleness Tracking

Each downstream repo has a maximum allowed sync age. If the last sync exceeds this threshold, an alert fires.

| Metric | Threshold | Alert Channel |
|--------|-----------|---------------|
| **Days since last sync** | > 14 days (on_release), > 7 days (on_change) | Notification to orchestrator |
| **Upstream releases missed** | > 1 release behind | Escalation to repo owner |
| **Failed sync attempts** | > 2 consecutive failures | Escalation to orchestrator + repo owner |

### Drift Detection

Drift occurs when downstream files diverge from their upstream source outside of `.agent33-overrides/`.

- **Detection method:** Compare checksums of synced files against expected values from last sync state.
- **Frequency:** Daily automated check.
- **Action on drift:** Open issue in downstream repo with list of drifted files and suggested remediation (re-sync or move changes to `.agent33-overrides/`).

### Failure Notifications

```yaml
sync_alert:
  type: failure | staleness | drift
  rule_id: "sync-webapp-orchestrator"
  target_repo: "org/webapp"
  detected_at: "2026-01-30T12:00:00Z"
  details: "Checksum mismatch on 2 files after transform"
  action_required: "Review sync PR #789 or trigger manual re-sync"
```

---

## Downstream Registry

All downstream repos consuming AGENT-33 assets are tracked here.

| Repo | Sync Rule ID | Strategy | Frequency | Last Sync | Version | Status |
|------|-------------|----------|-----------|-----------|---------|--------|
| `org/webapp` | `sync-webapp-orchestrator` | copy | on_release | 2026-01-28 | v2.4.0 | Current |
| `org/api-service` | `sync-api-prompts` | copy | on_release | 2026-01-28 | v2.4.0 | Current |
| `org/ml-pipeline` | `sync-ml-arch` | template | on_change | 2026-01-25 | v2.3.1 | Behind |
| `org/docs-site` | `sync-docs-full` | reference | manual | 2026-01-15 | v2.3.0 | Stale |

### Adding a New Downstream Repo

1. Create a sync rule YAML in `core/orchestrator/distribution/rules/`.
2. Add the repo to the downstream registry table above.
3. Run an initial sync with `strategy: copy` and `frequency: manual` to validate.
4. Switch to desired frequency after first successful sync.
5. Ensure downstream repo has `.agent33-overrides/` and `.agent33-sync-state/` directories.

### Removing a Downstream Repo

1. Set sync rule frequency to `manual`.
2. Remove the repo from the downstream registry table.
3. Archive the sync rule YAML (move to `rules/archived/`).
4. Downstream repo retains last-synced files but receives no further updates.
