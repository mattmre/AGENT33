name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  merge-sequencing-guard:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Enforce sequence label ordering
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map((label) => label.name);
            const sequenceLabels = labels.filter((name) => /^sequence:[1-3]$/.test(name));

            if (sequenceLabels.length === 0) {
              core.notice("No sequence label found on PR. Skipping merge sequencing guard.");
              return;
            }

            if (sequenceLabels.length > 1) {
              core.setFailed(`Expected a single sequence label, found: ${sequenceLabels.join(", ")}`);
              return;
            }

            const currentLabel = sequenceLabels[0];
            const currentSequence = Number(currentLabel.split(":")[1]);

            if (currentSequence === 1) {
              core.info("PR is sequence:1. No predecessor required.");
              return;
            }

            const predecessorLabel = `sequence:${currentSequence - 1}`;
            const baseBranch = context.payload.pull_request.base.ref;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const closedPulls = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: "closed",
              base: baseBranch,
              per_page: 100,
            });

            const predecessor = closedPulls.find((pr) => {
              const prLabels = (pr.labels || []).map((label) => label.name);
              return pr.merged_at && prLabels.includes(predecessorLabel);
            });

            if (!predecessor) {
              core.setFailed(
                `Missing merged predecessor on base branch '${baseBranch}'. ` +
                `PRs labeled '${currentLabel}' require a merged '${predecessorLabel}'.`
              );
              return;
            }

            core.info(
              `Merge sequencing check passed. Found predecessor #${predecessor.number} ` +
              `(${predecessorLabel}) merged into '${baseBranch}'.`
            );

  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: engine
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Ruff check (non-blocking baseline)
        # TODO: Re-enable blocking Ruff once repository-wide lint debt is remediated.
        continue-on-error: true
        run: ruff check src/ tests/

      - name: Ruff format check
        run: ruff format --check src/ tests/

      - name: Mypy (non-blocking baseline)
        # TODO: Re-enable blocking mypy once baseline strict-type debt is remediated.
        continue-on-error: true
        run: mypy src/

  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: engine
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run tests
        run: pytest --cov=agent33 --cov-report=term-missing -x -q

  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: engine
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker images
        run: docker compose build

  benchmark-smoke:
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: engine
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run smoke benchmarks
        env:
          AGENT33_SMOKE_CTRF_PATH: test-results/ctrf-smoke-report.json
        run: |
          pytest tests/benchmarks/test_skills_smoke.py -v \
            --tb=short

      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-smoke-results
          path: engine/test-results/
          retention-days: 30
