# Session 40 — Phase 32 Adoption, Persistence Hardening, Observability Integration

**Date**: 2026-02-24  
**Focus/Goal**: Complete the 15-item next-session priority set via orchestrated PR-1/PR-2/PR-3 delivery, with validated merge gates and research/session tracking.

## Agent Orchestration Summary

- **Researcher wave**: validated current-state gaps against `docs/next-session.md`, review packets, and runtime code surfaces.
- **Architect wave**: produced actionable gap-closure plan and PR-slice acceptance criteria.
- **Implementer wave 1 (PR-1)**: expanded connector-boundary adoption and policy-pack enforcement across reader/search/MCP client paths.
- **Implementer wave 2 (PR-2)**: hardened migration backup flow and SQLite corruption recovery/validation.
- **Implementer wave 3 (PR-3)**: wired effort-routing telemetry emission into workflow bridge runtime path and observability metrics flow.
- **Reviewer waves**: iteratively closed blocker findings before final approvals for each PR slice.

## Code Changes by PR

### PR-1 — Phase 32 Adoption
- Expanded strict-web policy-pack coverage (`web_fetch`, `http_request`, `search`, `reader`).
- Added boundary-governed Reader tool execution (Jina + local fetch).
- Added MCP client manager boundary call path and scanner integration.
- Added redirect-block policy behavior in reader/web fetch for allowlist safety.

**Primary files**
- `engine/src/agent33/connectors/boundary.py`
- `engine/src/agent33/tools/builtin/{reader.py,search.py,web_fetch.py}`
- `engine/src/agent33/tools/mcp_client.py`
- `engine/src/agent33/component_security/mcp_scanner.py`
- `engine/tests/{test_phase32_connector_boundary.py,test_mcp_scanner.py,test_tools_reader.py}`
- `docs/default-policy-packs.md`

### PR-2 — Persistence Hardening + Migration Path
- Added optional migration backup-on-start behavior and backup path settings.
- Added SQLite corruption-mode support (`reset|raise`) with payload sidecar and DB quarantine behavior.
- Added migration safety gate to avoid overwriting non-empty DB state.
- Added strict settings validation for corruption behavior values.

**Primary files**
- `engine/src/agent33/improvement/persistence.py`
- `engine/src/agent33/api/routes/improvements.py`
- `engine/src/agent33/config.py`
- `engine/tests/test_phase31_learning_signals.py`

### PR-3 — Observability Integration
- Added runtime-level routing metrics emitter hook in `AgentRuntime`.
- Wired workflow bridge to pass effort router + routing metrics emitter.
- Added workflow-bridge telemetry test coverage verifying routed model + metrics export.

**Primary files**
- `engine/src/agent33/agents/runtime.py`
- `engine/src/agent33/main.py`
- `engine/tests/test_phase30_effort_routing.py`

## Validation Evidence

```bash
cd engine && python -m pytest tests/test_phase32_connector_boundary.py -q
# 13 passed, 1 skipped

cd engine && python -m pytest tests/test_phase32_connector_boundary.py tests/test_tools_search.py tests/test_security_hardening.py tests/test_architecture_gaps.py tests/test_mcp_scanner.py -q
# 94 passed, 2 skipped

cd engine && python -m pytest tests/test_phase31_learning_signals.py -q
# 22 passed

cd engine && python -m pytest tests/test_phase30_effort_routing.py tests/test_integration_wiring.py -q
# 40 passed

cd engine && python -m pytest tests/test_phase30_effort_routing.py -q
# 16 passed

cd engine && python -m pytest tests/test_phase30_effort_routing.py tests/test_phase31_learning_signals.py tests/test_phase32_connector_boundary.py tests/test_tool_loop.py tests/test_invoke_iterative.py tests/test_skill_matching.py tests/test_context_manager.py -q
# 213 passed, 1 skipped
```

## Known Issues / Next Steps

1. Finalize and publish PR-1/PR-2/PR-3 review branches and sequencing labels.
2. Add durable exporter strategy for effort-routing metrics if required beyond in-memory dashboard snapshots.
3. Continue broader connector adoption inventory for any remaining outbound network surfaces.
