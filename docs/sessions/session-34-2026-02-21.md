# Session 34 — Phase 28 Revised: Enterprise Security Scanning Integration

**Date**: 2026-02-21
**Goal**: Replace all PentAGI references with enterprise-grade security tooling (5-stage plan)
**Branch**: `feat/phase28-enterprise-security-scanning`
**PR**: #52

## Summary

Completed full Phase 28 revision across 5 stages: renamed PentAGI → SecurityScan, added SARIF 2.1.0 bidirectional converter, integrated MCP security servers, built AI/LLM security scanning layer, and created frontend security dashboard. Used parallel agent execution (4 background agents for Stages 2-5) after completing Stage 1 sequentially. All 80 Phase 28 tests pass, frontend builds clean, zero PentAGI references remain.

## Actions Completed

### Stage 1: Rename PentAGI → SecurityScan (Zero Functional Changes)

- Renamed `pentagi_integration.py` → `security_scan.py` (git detected as rename at 96% similarity)
- Renamed classes: `PentAGIService` → `SecurityScanService`, `PentAGIServiceError` → `SecurityScanError`
- Updated all imports in routes, tests, and documentation
- Deleted original file
- Updated `docs/phases/PHASE-28-*.md` title and references
- Updated `docs/phases/README.md` index entry
- Added deprecation header to `docs/research/phase28-pentagi-integration-analysis.md`

### Stage 2: SARIF 2.1.0 + Claude Code Security

**New files**:
- `engine/src/agent33/component_security/sarif.py` — Bidirectional converter (findings ↔ SARIF 2.1.0)
- `engine/src/agent33/component_security/claude_security.py` — Claude Code Security adapter stub
- `engine/tests/test_sarif_converter.py` — 19 tests (round-trip, external SARIF, edge cases, route integration)

**Modified files**:
- `engine/src/agent33/services/security_scan.py` — Added `sarif_export()` method
- `engine/src/agent33/api/routes/component_security.py` — Added `GET /runs/{run_id}/sarif` endpoint
- `.github/workflows/security-scan.yml` — Added Trivy SARIF + Claude Code Security CI jobs

### Stage 3: MCP Security Server Integration

**New files**:
- `engine/src/agent33/component_security/mcp_scanner.py` — `MCPSecurityScanner` with STDIO/SSE transports, Semgrep/Trivy pre-registered configs
- `engine/tests/test_mcp_scanner.py` — 22 tests (registration, parsing, routes)

**Modified files**:
- `engine/src/agent33/api/routes/component_security.py` — Added MCP CRUD endpoints (POST/GET/DELETE)

### Stage 4: AI/LLM Security Layer

**New files**:
- `engine/src/agent33/component_security/llm_security.py` — Prompt injection, OWASP MCP Top 10, tool poisoning/shadowing detection, LLMGuard/Garak stubs
- `engine/tests/test_llm_security.py` — 22 tests

**Modified files**:
- `engine/src/agent33/component_security/models.py` — Added 4 FindingCategory values (PROMPT_INJECTION, TOOL_POISONING, SUPPLY_CHAIN, MODEL_SECURITY)
- `engine/src/agent33/api/routes/component_security.py` — Added `POST /runs/{run_id}/llm-scan` endpoint

### Stage 5: Frontend Security Dashboard

**New files**:
- `frontend/src/features/security-dashboard/SecurityDashboard.tsx` — Main dashboard (scan history, severity summary, quick scan, SARIF download)
- `frontend/src/features/security-dashboard/ScanRunCard.tsx` — Run card with status, findings mini-summary, SARIF button
- `frontend/src/features/security-dashboard/FindingsTable.tsx` — Sortable/filterable findings table with expandable detail rows
- `frontend/src/features/security-dashboard/__tests__/SecurityDashboard.test.ts` — 6 module tests

**Modified files**:
- `frontend/src/components/DomainPanel.tsx` — Wired SecurityDashboard for component-security domain
- `frontend/src/data/domains/componentSecurity.ts` — Added 5 new operations (12 total)
- `frontend/src/data/domains/componentSecurity.test.ts` — Updated to 10 tests

## Validation Evidence

```bash
# Phase 28 engine tests
cd engine
python -m pytest tests/test_component_security_api.py tests/test_sarif_converter.py tests/test_mcp_scanner.py tests/test_llm_security.py -q
# 80 passed in 0.44s

# Phase 28 lint
python -m ruff check src/agent33/component_security/ src/agent33/services/security_scan.py src/agent33/api/routes/component_security.py tests/test_component_security_api.py tests/test_sarif_converter.py tests/test_mcp_scanner.py tests/test_llm_security.py
# All checks passed!

# Full engine suite
python -m pytest tests/ --ignore=tests/benchmarks -q --tb=no
# 1706 passed, 3 failed (pre-existing infra failures)

# Zero PentAGI references
grep -r "PentAGI\|pentagi" src/ tests/
# (no output — zero hits)

# Frontend
cd ../frontend
npx tsc --noEmit          # clean
npx vitest run            # 33 passed (5 test files)
npm run build             # 386 KB production build
```

## Issues Encountered

| Issue | Impact | Resolution |
|-------|--------|------------|
| `replace_all` of `PentAGIService` also caught `PentAGIServiceError` in except clause, creating `SecurityScanServiceError` | Incorrect class name in except handler | Manual edit to fix `SecurityScanServiceError` → `SecurityScanError` |
| Stage 2 background agent failed to create files | SARIF converter not implemented | Implemented all Stage 2 files manually after detecting agent failure |
| `SecurityFinding` import in `claude_security.py` triggered TC001 (type-checking block) | Lint failure | Moved import to `TYPE_CHECKING` block |
| `zip()` in test without `strict=` triggered B905 | Lint failure | Added `strict=True` parameter |
| Full test suite takes 22+ minutes on Windows | Long feedback loop | Used targeted test runs for Phase 28 files, full suite as final validation |

## Agent Orchestration

- **Strategy**: Stage 1 sequential (rename is critical path), Stages 2-5 parallel via 4 background agents in worktrees
- **Stage 2 agent**: Failed (didn't create files) — implemented manually
- **Stage 3 agent**: Success (22 tests, MCP scanner + routes)
- **Stage 4 agent**: Success (22 tests, LLM security + models + routes)
- **Stage 5 agent**: Success (6 tests, 3 components + DomainPanel wiring + domain operations)
- **Deviation**: Stage 5 used module-level export tests instead of `@testing-library/react` render tests (library not installed in project)

## Test Count Breakdown

| File | Tests | Category |
|------|-------|----------|
| `test_component_security_api.py` | 17 | Existing (renamed) |
| `test_sarif_converter.py` | 19 | SARIF + Claude adapter + route |
| `test_mcp_scanner.py` | 22 | MCP scanner + routes |
| `test_llm_security.py` | 22 | LLM security |
| `SecurityDashboard.test.ts` | 6 | Frontend module |
| `componentSecurity.test.ts` | 10 | Frontend domain (+3 new) |
| **Total** | **96** | |

## New API Endpoints

| Method | Path | Scope |
|--------|------|-------|
| GET | `/v1/component-security/runs/{run_id}/sarif` | `component-security:read` |
| POST | `/v1/component-security/runs/{run_id}/llm-scan` | `component-security:write` |
| POST | `/v1/component-security/mcp-servers` | `component-security:write` |
| GET | `/v1/component-security/mcp-servers` | `component-security:read` |
| DELETE | `/v1/component-security/mcp-servers/{name}` | `component-security:write` |

## Next Steps

- [ ] Merge PR #52
- [ ] Phase 27 Stage 2: Operations Hub Frontend
- [ ] Phase 29 Stage 2: Real Multimodal Provider Integration
- [ ] Phase 30 Stage 2: Outcome Dashboard UI
- [ ] SkillsBench smoke harness expansion
