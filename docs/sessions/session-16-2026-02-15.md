# Session 16 — PR Review, Fix & Merge

**Date**: 2026-02-15
**Goal**: Review all open PR comments, fix issues, merge all 6 PRs to main
**Method**: Review → Triage → Fix → Test → Post comments → Sequential merge
**Result**: All PRs merged, 1,187 tests passing, 0 lint errors, 0 open PRs

## Starting State

- **Branch**: `main` (973 tests on main, ~1,030+ across feature branches)
- **Open PRs**: #7 (P0), #8 (P1), #9 (P2), #10 (P5), #11 (P3), #12 (P4), #13 (duplicate)
- **Reviewers**: GitHub Copilot, Gemini Code Assist
- **Total review comments**: 50+ inline comments across 7 PRs

## Phase 1: Review Triage

Catalogued all review comments from Copilot and Gemini Code Assist:

| PR | Branch | Comments | Critical Issues |
|----|--------|----------|----------------|
| #13 | `claude/review-pr-merge-BbJMJ` | 8 | Duplicate of #12 — closed |
| #7 | P0 — Tool Loop | 8 | Tool call desync, Ollama format, governance bypass |
| #8 | P1 — Skill Matching | 1 | Greedy regex |
| #9 | P2 — Context Window | 7 | Docstring, role, magic numbers, performance |
| #10 | P5 — AWM Analysis | 2 | Token counting description |
| #11 | P3 — Architecture Gaps | 15 | SSRF, fitz leak, depth limit, route validation |
| #12 | P4 — BM25 Warm-Up | 4+8 | Row mapping bug, validation, O(n^2) |

## Phase 2: Fixes Applied

### PR #13 — Closed (duplicate)
- Identified as cherry-pick of PR #12 from a previous automation attempt
- Closed with comment, remote branch deleted

### PR #10 — AWM Analysis (2 fixes)
- Fixed token counting description: both word-based (words * 1.3) and char-ratio (3.5 chars/token) methods noted
- Two locations updated (line 129 + comparison table line 535)

### PR #7 — Iterative Tool Loop (6 fixes)
1. **Ollama tool format**: Wrap tool defs in `{"type": "function", "function": {...}}` for provider consistency
2. **Mutable defaults**: `inputs: dict` → `Field(default_factory=dict)` in both InvokeRequest and InvokeIterativeRequest
3. **Model router consistency**: Both `/invoke` and `/invoke-iterative` now prefer `app.state.model_router` with module-level fallback
4. **Tool call capping desync** (critical): Assistant message now only includes processed `tool_calls` (sliced to match results length), preventing conversation desync with OpenAI-style APIs
5. **Governance bypass**: Governance checks run whenever governance is configured, using `_default_context()` as fallback when no explicit ToolContext
6. **RuntimeEnforcer dispatch**: Now dispatches by tool type — `shell` → `check_command(args)`, `file_ops` → `check_file_read/write(path)`, `web_fetch` → `check_network(url)`

### PR #8 — Skill Matching (1 fix)
- **Balanced brace JSON parsing**: Replaced greedy regex `{.*}` with a depth-tracking brace parser that correctly handles nested structures like `{"keep": [...], "reject": [{"name": "..."}]}`

### PR #9 — Context Window Management (6 fixes)
1. **Docstring accuracy**: Removed incorrect `Raises: RuntimeError` — method gracefully falls back to simple summary
2. **Unwind performance**: Track running token count and subtract (O(n) vs O(n*m) re-estimation per iteration)
3. **System message edge case**: Warning log when system messages alone exceed target tokens
4. **Summary role**: Kept as `"user"` intentionally (documented) — `"system"` would make it un-removable during unwinding
5. **Magic numbers**: Extracted to `_MAX_MESSAGE_PREVIEW_CHARS=500`, `_MAX_FALLBACK_PREVIEW_CHARS=100`, `_MAX_FALLBACK_PREVIEW_MESSAGES=10`
6. **Exception specificity**: Broad catch is intentional for LLM summarization resilience

### PR #11 — Architecture Gaps (9 fixes)

**Security:**
1. **SSRF protection**: IP blocklist for private/reserved ranges (127/8, 10/8, 172.16/12, 192.168/16, localhost, IPv6 link-local/ULA)
2. **Redirect protection**: `follow_redirects=False` to prevent redirect-based SSRF
3. **Route agent validation**: LLM-selected agent must be in candidate list; falls back with warning

**Robustness:**
4. **PDF size limits**: Max 100MB file, max 5000 pages
5. **Image size limits**: Max 50MB for OCR
6. **Fitz context manager**: `with fitz.open(...)` prevents handle leaks on errors
7. **Sub-workflow depth limit**: Max 10 levels via `contextvars` (concurrent-safe)
8. **HTTP error handling**: Wrapped `httpx.TimeoutException`, `ConnectError`, `HTTPError`
9. **Timeout documentation**: Docstring note about per-request vs step-level timeout interaction

### PR #12 — BM25 Warm-Up (7 fixes, incorporating PR #13 feedback)

**Bug fix:**
1. **SearchResult row mapping**: Fixed score/metadata swap (SQL returns content, metadata, score but code read them in wrong order)

**Validation:**
2. **Literal types**: `content_type` and `chunk_strategy` now use `Literal[...]`
3. **Field validators**: `chunk_size > 0`, `chunk_overlap >= 0`, `chunk_overlap < chunk_size` via `@model_validator` (proper 422 vs 500)
4. **Mutable default**: `metadata` → `Field(default_factory=dict)`

**Performance:**
5. **Batch add_documents**: Both ingestion endpoint and warm-up use `bm25_index.add_documents()` (O(n) vs O(n^2))

**Code quality:**
6. **request.app.state**: Replaced `from agent33.main import app` with `request.app.state`
7. **exc_info logging**: Warm-up failure now logs with `exc_info=True`

## Phase 3: Merge Sequence

Sequential squash-merge with rebase between each:

| Order | PR | Subject | Conflicts |
|-------|-----|---------|-----------|
| 1 | #10 | docs: Agent World Model analysis & adaptation roadmap | None |
| 2 | #7 | feat: implement iterative tool-use loop (P0) | None |
| 3 | #8 | feat: add 4-stage hybrid skill matching (P1) | None |
| 4 | #9 | feat: add context window management (P2) | None |
| 5 | #11 | feat: architecture gaps — document processing, workflow actions, LLM routing | None (1 cherry-pick skipped) |
| 6 | #12 | feat: BM25 warm-up & ingestion pipeline | None |

All merges clean — no conflicts. Each branch rebased and tests verified before merge.

## Final Validation

```
$ python -m pytest tests/ -q
1187 passed in 1390.63s (0:23:10)

$ python -m ruff check src/ tests/
All checks passed!
```

## Summary of Changes to Main

| Commit | Files | Lines |
|--------|-------|-------|
| #10 AWM Analysis | 1 | +685 |
| #7 Tool Loop | 15 | +3,789/-11 |
| #8 Skill Matching | 2 | +1,311 |
| #9 Context Window | 2 | +1,109 |
| #11 Architecture Gaps | 7 | +1,296/-13 |
| #12 BM25 Warm-Up | 6 | +727/-10 |
| **Total** | **33** | **+8,917/-34** |

## Post-Merge Cleanup
- Closed PR #13 (duplicate, remote branch deleted)
- Deleted 6 local feature branches
- Posted summary comments on all 6 merged PRs
- Updated MEMORY.md with session 16 state
